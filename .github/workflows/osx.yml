---
name: macOS10.14 build and test

on:
  pull_request:
    branches:
      - master


jobs:
  OSX:
    runs-on: macOS-10.14

    steps:
      - name: Install Dependencies
        run: brew install openssl@1.1

      - name: Checkout PR
        uses: actions/checkout@v2

      - name: Checkout Dependencies
        uses: actions/checkout@v2
        with:
          repository: "aws/aws-sdk-cpp"
          ref: "1.7.231"
          path: "aws-sdk-cpp"

      - name: Build and install aws-sdk-cpp
        run: |
          mkdir -p build-aws-sdk-cpp ||true
          mkdir -p install || true
          cd build-aws-sdk-cpp
          cmake -G Xcode -DTARGET_ARCH="APPLE" -DBUILD_SHARED_LIBS=ON -DBUILD_ONLY="kms" -DENABLE_UNITY_BUILD=ON ../aws-sdk-cpp
          xcodebuild -target ALL_BUILD
          xcodebuild -target install

      - name: Build C-ESDK
        run: |
          mkdir build-aws-encryption-sdk-c || true
          cd build-aws-encryption-sdk-c
          cmake -G Xcode -DBUILD_SHARED_LIBS=ON -DOPENSSL_ROOT_DIR="/usr/local/opt/openssl@1.1" ../
          xcodebuild -target ALL_BUILD
          xcodebuild -scheme RUN_TESTS
